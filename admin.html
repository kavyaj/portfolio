<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Admin - Kavya Jahagirdar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Big+Shoulders+Display:wght@400;500;600;700;800;900&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .admin-header {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }
        .admin-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .admin-nav button {
            padding: 0.75rem 1.5rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
        }
        .admin-nav button.active {
            background: #fd5183;
            color: white;
            border-color: #fd5183;
        }
        .admin-nav button:hover:not(.active) {
            background: #f9fafb;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
        }
        .form-group textarea {
            min-height: 300px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            font-size: 1rem;
        }
        .btn-primary {
            background: #fd5183;
            color: white;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .post-list {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .post-item {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        .post-item:last-child {
            border-bottom: none;
        }
        .post-info {
            flex: 1;
        }
        .post-title {
            font-family: 'Big Shoulders Display', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: #fd5183;
            margin-bottom: 0.5rem;
        }
        .post-meta {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .post-actions {
            display: flex;
            gap: 0.5rem;
        }
        .post-actions button {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .hidden {
            display: none;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 1rem;
        }
        .status-published {
            background: #d1fae5;
            color: #065f46;
        }
        .status-draft {
            background: #fef3c7;
            color: #92400e;
        }
        .preview-content {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
            background: #f9fafb;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1 class="display-heading-large">Blog Admin</h1>
            <p class="tagline">Write and manage your blog posts</p>
        </div>

        <div class="admin-nav">
            <button id="nav-posts" class="active">All Posts</button>
            <button id="nav-new">New Post</button>
        </div>

        <!-- Posts List View -->
        <div id="posts-view">
            <div id="posts-list">
                <div style="text-align: center; padding: 2rem;">
                    <p>Loading posts...</p>
                </div>
            </div>
        </div>

        <!-- New/Edit Post View -->
        <div id="editor-view" class="hidden">
            <form id="post-form">
                <div class="form-group">
                    <label for="post-title">Title</label>
                    <input type="text" id="post-title" name="title" required>
                </div>
                
                <div class="form-group">
                    <label for="post-content">Content (Markdown)</label>
                    <textarea id="post-content" name="content" placeholder="Write your post in Markdown..." required></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="post-published" name="published">
                        Publish immediately
                    </label>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Post</button>
                    <button type="button" class="btn btn-secondary" id="preview-btn">Preview</button>
                    <button type="button" class="btn btn-secondary" id="cancel-btn">Cancel</button>
                </div>
            </form>

            <div id="preview-section" class="hidden">
                <h3>Preview</h3>
                <div id="preview-content" class="preview-content"></div>
            </div>
        </div>
    </div>

    <script>
        let currentPost = null;

        // Navigation
        document.getElementById('nav-posts').addEventListener('click', () => showPostsList());
        document.getElementById('nav-new').addEventListener('click', () => showEditor());
        document.getElementById('cancel-btn').addEventListener('click', () => showPostsList());

        // Form handling
        document.getElementById('post-form').addEventListener('submit', handleFormSubmit);
        document.getElementById('preview-btn').addEventListener('click', showPreview);

        function showPostsList() {
            document.getElementById('posts-view').classList.remove('hidden');
            document.getElementById('editor-view').classList.add('hidden');
            document.getElementById('nav-posts').classList.add('active');
            document.getElementById('nav-new').classList.remove('active');
            loadPosts();
        }

        function showEditor(post = null) {
            document.getElementById('posts-view').classList.add('hidden');
            document.getElementById('editor-view').classList.remove('hidden');
            document.getElementById('nav-posts').classList.remove('active');
            document.getElementById('nav-new').classList.add('active');
            document.getElementById('preview-section').classList.add('hidden');
            
            currentPost = post;
            if (post) {
                document.getElementById('post-title').value = post.title;
                document.getElementById('post-content').value = post.markdown_content;
                document.getElementById('post-published').checked = post.published;
            } else {
                document.getElementById('post-form').reset();
            }
        }

        async function loadPosts() {
            try {
                const response = await fetch('/api/admin/blog/posts');
                const posts = await response.json();
                
                const postsContainer = document.getElementById('posts-list');
                
                if (posts.length === 0) {
                    postsContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem;">
                            <p class="body-text">No posts yet. Create your first post!</p>
                            <button class="btn btn-primary" onclick="showEditor()">Create Post</button>
                        </div>
                    `;
                    return;
                }

                postsContainer.innerHTML = `
                    <div class="post-list">
                        ${posts.map(post => `
                            <div class="post-item">
                                <div class="post-info">
                                    <div class="post-title">${post.title}
                                        <span class="status-badge ${post.published ? 'status-published' : 'status-draft'}">
                                            ${post.published ? 'Published' : 'Draft'}
                                        </span>
                                    </div>
                                    <div class="post-meta">
                                        Created: ${new Date(post.created_at).toLocaleDateString()}
                                        ${post.updated_at !== post.created_at ? 
                                            ` • Updated: ${new Date(post.updated_at).toLocaleDateString()}` : ''}
                                    </div>
                                </div>
                                <div class="post-actions">
                                    <button onclick="showEditor(${JSON.stringify(post).replace(/"/g, '&quot;')})">Edit</button>
                                    <button onclick="deletePost(${post.id})">Delete</button>
                                    ${post.published ? `<a href="/post.html?slug=${post.slug}" target="_blank"><button>View</button></a>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading posts:', error);
                document.getElementById('posts-list').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p class="body-text">Error loading posts. Please try again.</p>
                    </div>
                `;
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const postData = {
                title: formData.get('title'),
                content: formData.get('content'),
                published: formData.has('published')
            };

            try {
                const url = currentPost ? 
                    `/api/admin/blog/posts/${currentPost.id}` : 
                    '/api/admin/blog/posts';
                
                const method = currentPost ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save post');
                }

                alert(currentPost ? 'Post updated successfully!' : 'Post created successfully!');
                showPostsList();
            } catch (error) {
                console.error('Error saving post:', error);
                alert('Error saving post: ' + error.message);
            }
        }

        async function deletePost(id) {
            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/blog/posts/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete post');
                }

                alert('Post deleted successfully!');
                loadPosts();
            } catch (error) {
                console.error('Error deleting post:', error);
                alert('Error deleting post: ' + error.message);
            }
        }

        async function showPreview() {
            const content = document.getElementById('post-content').value;
            if (!content.trim()) {
                alert('Please enter some content to preview');
                return;
            }

            try {
                // Simple markdown preview (basic implementation)
                let html = content
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                    .replace(/\*(.*)\*/gim, '<em>$1</em>')
                    .replace(/`(.*?)`/gim, '<code>$1</code>')
                    .replace(/\n\n/gim, '</p><p>')
                    .replace(/\n/gim, '<br>');
                
                html = '<p>' + html + '</p>';

                document.getElementById('preview-content').innerHTML = html;
                document.getElementById('preview-section').classList.remove('hidden');
            } catch (error) {
                console.error('Error generating preview:', error);
                alert('Error generating preview');
            }
        }

        // Load posts on page load
        document.addEventListener('DOMContentLoaded', loadPosts);
    </script>
</body>
</html>